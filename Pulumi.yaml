name: homelab-infra
runtime:
  name: python
  options:
    virtualenv: venv
description: Infra for hosting service
config:
  server:
    value:
      platform: amd64
  docker:
    value:
      env:
        TZ: Etc/UTC
      image:
        tailscale:
          name: tailscale/tailscale
          tag: "v1.44.0"
        workaround:
          name: busybox
          tag: "1.35-uclibc"
        traefik:
          name: traefik
          tag: "v3.0.0-beta3"
        dozzle:
          name: amir20/dozzle
          tag: "v4.10.19"
      volume:
        local:
          - tailscale-state
          - traefik-config
          - traefik-cert
        bind:
          # https://rclone.org/docker/
          rclone-config: /var/lib/docker-plugins/rclone/config
          rclone-cache: /var/lib/docker-plugins/rclone/cache
  storage:
    value:
      rclone:
        plugin:
          version: "'{}-1.63.1'.format(platform)"
  tailscale:
    value:
      state:
        volume: tailscale-state
        dir: /var/lib/tailscale/
      port:
        internal: 444
        external: 443
      socket: /var/run/tailscale/tailscaled.sock
  traefik:
    value:
      config:
        volume: traefik-config
        dir: /etc/traefik/config/
      cert:
        volume: traefik-cert
        dir: /etc/traefik/cert/
      # TODO: Upgrade to v3
      schema:
        static: https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/traefik-v2.json
        dynamic: https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/traefik-v2-file-provider.json
