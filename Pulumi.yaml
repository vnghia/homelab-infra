name: homelab-infra
runtime:
  name: python
  options:
    virtualenv: venv
description: Infra for hosting service
config:
  server:
    value:
      platform: amd64
  docker:
    value:
      env:
        TZ: Etc/UTC
      image:
        tailscale:
          name: tailscale/tailscale
          tag: "v1.44.0"
        workaround:
          name: busybox
          tag: "1.35-uclibc"
        traefik:
          name: traefik
          tag: "v3.0.0-beta3"
        dozzle:
          name: amir20/dozzle
          tag: "v4.10.19"
        navidrome:
          name: deluan/navidrome
          tag: "0.49.3"
        syncthing:
          name: syncthing/syncthing
          tag: "1.23"
        rclone:
          name: rclone/rclone
          tag: "1.63"
        crowdsec:
          name: crowdsecurity/crowdsec
          tag: "v1.5.2"
        ntfy:
          name: binwiederhier/ntfy
          tag: "v2.6.2"
      volume:
        local:
          tailscale-state:
          traefik-config:
          traefik-cert:
          navidrome-data:
            key:
              - navidrome-encryption
          syncthing-config:
          crowdsec-config:
          crowdsec-data:
          ntfy-config:
          ntfy-cache:
          ntfy-data:
        bind:
          # https://rclone.org/docker/
          rclone-config: /var/lib/docker-plugins/rclone/config
          rclone-cache: /var/lib/docker-plugins/rclone/cache
  storage:
    value:
      rclone:
        plugin:
          version: "'{}-1.63.1'.format(platform)"
        mount:
          music: music/original/
        crypt:
          password: crypt/password/
        combine:
          crypt-password: password
  tailscale:
    value:
      volume:
        state:
          volume: tailscale-state
          dir: /var/lib/tailscale/
      port:
        internal: 444
        external: 443
      socket: /var/run/tailscale/tailscaled.sock
  traefik:
    value:
      volume:
        config:
          volume: traefik-config
          dir: /etc/traefik/config/
          ro: true
        cert:
          volume: traefik-cert
          dir: /etc/traefik/cert/
      # TODO: Upgrade to v3
      schema:
        static: https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/traefik-v2.json
        dynamic: https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/traefik-v2-file-provider.json
      plugin:
        crowdsec:
          name: github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
          version: "v1.1.13"
  secret_:
    value:
      key:
        navidrome-encryption:
      account:
        navidrome:
          hostname: public-navidrome
        ntfy:
          hostname: public-ntfy
  navidrome:
    value:
      volume:
        music:
          volume: mount-music
          dir: /music/
          ro: true
        data:
          volume: navidrome-data
          dir: /data/
  rclone:
    value:
      volume:
        config:
          volume: rclone-config
          dir: /etc/rclone/
          ro: true
      port: 8080
  syncthing:
    value:
      volume:
        config:
          volume: syncthing-config
          dir: /var/syncthing/
        password:
          volume: crypt-password
          dir: /var/syncthing/data/password/
  crowdsec:
    value:
      volume:
        config:
          volume: crowdsec-config
          dir: /etc/crowdsec/
        data:
          volume: crowdsec-data
          dir: /var/lib/crowdsec/data
  ntfy:
    value:
      volume:
        config:
          volume: ntfy-config
          dir: /etc/ntfy/
          ro: true
        cache:
          volume: ntfy-cache
          dir: /var/cache/ntfy/
        data:
          volume: ntfy-data
          dir: /var/lib/ntfy/
