name: homelab-infra
runtime:
  name: python
  options:
    virtualenv: venv
description: Infra for hosting service
config:
  server:
    value:
      platform: amd64
  secret_:
    value:
      key:
        navidrome-encryption:
      account:
        navidrome:
          hostname: public-navidrome
        ntfy:
          hostname: public-ntfy
        rclone:
          hostname: public-rclone
  docker:
    value:
      env:
        TZ: Etc/UTC
      image:
        tailscale:
          name: tailscale/tailscale
          tag: "v1.44.0"
        workaround:
          name: busybox
          tag: "1.35-uclibc"
        traefik:
          name: traefik
          tag: "v3.0.0-beta3"
        dozzle:
          name: amir20/dozzle
          tag: "v4.10.22"
        navidrome:
          name: deluan/navidrome
          tag: "0.49.3"
        syncthing:
          name: syncthing/syncthing
          tag: "1.23"
        rclone:
          name: rclone/rclone
          tag: "1.63"
        crowdsec:
          name: crowdsecurity/crowdsec
          tag: "v1.5.2"
        ntfy:
          name: binwiederhier/ntfy
          tag: "v2.6.2"
        wireguard:
          name: linuxserver/wireguard
          tag: "1.0.20210914"
      plugin:
        rclone:
          name: rclone/docker-volume-rclone
          version: "'{}-1.63.1'.format(platform)"
  storage:
    value:
      volume:
        local:
          tailscale-state:
          traefik-config:
          traefik-cert:
          navidrome-data:
            key:
              - navidrome-encryption
          syncthing-config:
          crowdsec-data:
          ntfy-cache:
          ntfy-data:
        bind:
          # https://rclone.org/docker/
          rclone-config: /var/lib/docker-plugins/rclone/config
          rclone-cache: /var/lib/docker-plugins/rclone/cache
        mount:
          music: music/original/
        crypt:
          password: crypt/password/
        combine:
          crypt-password: password
      container:
        tailscale:
          state:
            dir: /var/lib/tailscale/
        traefik:
          config:
            dir: /etc/traefik/config/
            ro: true
          cert:
            dir: /etc/traefik/cert/
        navidrome:
          music:
            volume: mount-music
            dir: /music/
            ro: true
          data:
            volume: navidrome-data
            dir: /data/
        rclone-webdav:
          config:
            volume: rclone-config
            dir: /etc/rclone/
            ro: true
        syncthing:
          config:
            dir: /var/syncthing/
          password:
            volume: crypt-password
            dir: /var/syncthing/data/password/
        crowdsec:
          data:
            dir: /var/lib/crowdsec/data
        ntfy:
          cache:
            dir: /var/cache/ntfy/
          data:
            dir: /var/lib/ntfy/
  service:
    value:
      tailscale:
        port:
          internal: 444
          external: 443
        socket: /var/run/tailscale/tailscaled.sock
      traefik:
        # TODO: Upgrade to v3
        schema:
          static: https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/traefik-v2.json
          dynamic: https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/traefik-v2-file-provider.json
        plugin:
          crowdsec:
            name: github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
            version: "v1.1.13"
      rclone-webdav:
        port: 8080
