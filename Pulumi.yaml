name: homelab-infra
runtime:
  name: python
  options:
    virtualenv: venv
description: Infra for hosting service
config:
  server:
    value:
      platform: amd64
  secret_:
    value:
      key:
        navidrome-encryption:
        paperless-ngx-secret:
        authelia-jwt:
          length: 64
        authelia-session:
          length: 64
        authelia-storage-encryption:
          length: 64
      account:
        navidrome:
          hostname: public-navidrome
          custom:
            AndroidApp1: app.symfonik.music.player
        ntfy:
          hostname: public-ntfy
          custom:
            AndroidApp1: io.heckel.ntfy
        ntfy-write-only:
        jellyfin:
          hostname: private-jellyfin
          custom:
            AndroidApp1: org.jellyfin.mobile
        paperless-ngx:
          hostname: private-paperless-ngx
        memos:
          hostname: private-memos
          custom:
            AndroidApp1: me.mudkip.moememos
        immich:
          hostname: private-immich
          email: true
          custom:
            AndroidApp1: app.alextran.immich
        soulseek:
        monica:
          hostname: private-monica
          email: true
        linkwarden:
          hostname: private-linkwarden
        password-storage:
          authelia: true
        ryot:
          hostname: private-ryot
  docker:
    value:
      env:
        TZ: Etc/UTC
      image:
        tailscale:
          name: tailscale/tailscale
          tag: "v1.54.0"
        traefik:
          name: traefik
          tag: "v3.0.0-beta4"
        dozzle:
          name: amir20/dozzle
          tag: "v5.5.0"
        navidrome:
          name: ghcr.io/navidrome/navidrome
          tag: "0.50.1"
        syncthing:
          name: syncthing/syncthing
          tag: "1.26.0"
        rclone:
          name: rclone/rclone
          tag: "1.64.0"
        crowdsec:
          name: crowdsecurity/crowdsec
          tag: "v1.5.5"
        ntfy:
          name: binwiederhier/ntfy
          tag: "v2.8.0"
        awscli:
          name: amazon/aws-cli
          tag: "2.13.5"
        restic:
          name: restic/restic
          tag: "0.16.0"
        socat:
          name: alpine/socat
          tag: "1.7.4.4"
        jellyfin:
          name: linuxserver/jellyfin
          tag: "10.8.12"
        redis:
          name: redis
          tag: "7.2.2-alpine3.18"
        postgres:
          name: postgres
          tag: "16.0-bookworm"
        mariadb:
          name: mariadb
          tag: "11.2.2-jammy"
        paperless-ngx:
          name: ghcr.io/paperless-ngx/paperless-ngx
          tag: "2.0.0"
        neko-firefox:
          name: "'ghcr.io/m1k1o/neko/{}-firefox'.format('intel' if platform == 'amd64' else 'arm')"
          tag: &neko-browser-version "2.8.10"
        neko-tor-browser:
          name: "'ghcr.io/m1k1o/neko/{}-tor-browser'.format('intel' if platform == 'amd64' else 'arm')"
          tag: *neko-browser-version
        cloudflared:
          name: cloudflare/cloudflared
          tag: "2023.10.0"
        memos:
          name: ghcr.io/usememos/memos
          tag: "0.17.0"
        immich-server:
          name: ghcr.io/immich-app/immich-server
          tag: &immich-version "v1.88.1"
        immich-machine-learning:
          name: ghcr.io/immich-app/immich-machine-learning
          tag: *immich-version
        immich-typesense:
          name: typesense/typesense
          tag: "0.25.1"
        slskd:
          name: ghcr.io/slskd/slskd
          tag: "0.19.1"
        ttyd:
          name: tsl0922/ttyd
          tag: "1.7.4-alpine"
        script-server:
          name: bugy/script-server
          tag: "1.18.0"
        monica:
          name: ghcr.io/monicahq/monica-next
          tag: "main"
        linkwarden:
          name: ghcr.io/linkwarden/linkwarden
          tag: "v2.3.0"
        mailserver:
          name: ghcr.io/docker-mailserver/docker-mailserver
          tag: "13.0.0"
        authelia:
          name: authelia/authelia
          tag: "v4.38.0-beta3"
        meilisearch:
          name: getmeili/meilisearch
          tag: "v1.5.0"
        ryot:
          name: ghcr.io/ignisda/ryot
          tag: "v3.4.15"
        dufs:
          name: sigoden/dufs
          tag: "v0.38.0"
        python-alpine:
          name: python
          tag: "3.11.4-alpine3.18"
      build:
        backup:
          dockerfile: _data/backup/image/Dockerfile
          image:
            - python-alpine
            - restic
          material:
            - _data/backup/image/requirements.txt
            - _data/backup/image/*.py
        script-server:
          dockerfile: _service/script_server/image/Dockerfile
          image:
            - python-alpine
            - script-server
        ttyd:
          dockerfile: _service/ttyd/image/Dockerfile
          image:
            - ttyd
          material:
            - _service/ttyd/image/ns
        telegram:
          dockerfile: _service/telegram/image/Dockerfile
          image:
            - python-alpine
          material:
            - _service/telegram/image/requirements.txt
            - _service/telegram/image/*.py
      plugin:
        rclone:
          name: rclone/docker-volume-rclone
          version: "'{}-1.64.0'.format(platform)"
      compose:
        volume: docker-compose
  storage:
    value:
      volume:
        local:
          tailscale-state:
          traefik-config:
          traefik-cert:
          navidrome-data:
            key:
              - navidrome-encryption
          syncthing-config:
          crowdsec-config:
          crowdsec-data:
          ntfy-config:
          ntfy-cache:
          ntfy-data:
          docker-compose:
          restic-cache:
          script-server-log:
          telegram-session:
          jellyfin-config:
          jellyfin-cache:
          jellyfin-data:
          paperless-ngx-data:
          paperless-ngx-media:
          paperless-ngx-export:
          memos-data:
          immich-upload:
          immich-machine-learning-model-cache:
          immich-typesense-data:
          slskd-data:
          monica-data:
          mailserver-data:
          mailserver-state:
          mailserver-log:
          mailserver-config:
          mailserver-cert:
          authelia-config:
          meilisearch-data:
        bind:
          # https://rclone.org/docker/
          rclone-config: /var/lib/docker-plugins/rclone/config
          rclone-cache: /var/lib/docker-plugins/rclone/cache
        mount:
          music: music/original/
          memos-assets: memos/
        crypt:
          password: crypt/password/
          media: crypt/media/
          central: central/
          image: image/
      container:
        tailscale:
          state:
            dir: /var/lib/tailscale/
        traefik:
          config:
            dir: /etc/traefik/config/
            ro: true
          cert:
            dir: /etc/traefik/cert/
        navidrome:
          music:
            volume: mount-music
            dir: /music/
            ro: true
          data:
            volume: navidrome-data
            dir: /data/
        webdav-storage:
          config:
            volume: rclone-config
            dir: /etc/rclone/
            ro: true
        ftp-storage:
          config:
            volume: rclone-config
            dir: /etc/rclone/
            ro: true
        syncthing:
          config:
            dir: /var/syncthing/
          password:
            volume: crypt-password
            dir: /var/syncthing/data/password/
        crowdsec:
          config:
            dir: /etc/crowdsec/
          data:
            dir: /var/lib/crowdsec/data/
        ntfy:
          config:
            dir: /etc/ntfy/
            ro: true
          cache:
            dir: /var/cache/ntfy/
          data:
            dir: /var/lib/ntfy/
        script-server:
          log:
            dir: /app/logs/
          compose:
            volume: docker-compose
            dir: /app/compose/
            ro: true
        ttyd:
          compose:
            volume: docker-compose
            dir: /compose/
            ro: true
        telegram-login-code:
          session:
            volume: telegram-session
            dir: /telegram/session/
            ro: true
        jellyfin:
          config:
            dir: /config/
          cache:
            dir: /config/cache/
          data:
            dir: /config/data/
          media:
            volume: crypt-media
            dir: /media/
            ro: true
        paperless-ngx:
          data:
            dir: /usr/src/paperless/data/
          media:
            dir: /usr/src/paperless/media/
          export:
            dir: /usr/src/paperless/export/
        memos:
          data:
            dir: /var/opt/memos
          assets:
            volume: mount-memos-assets
            dir: /var/opt/memos/assets
        immich-server:
          upload:
            volume: immich-upload
            dir: /usr/src/app/upload/
          image-self:
            volume: crypt-image
            dir: /mnt/media/self/
            ro: true
        immich-microservices:
          upload:
            volume: immich-upload
            dir: /usr/src/app/upload/
          image-self:
            volume: crypt-image
            dir: /mnt/media/self/
            ro: true
        immich-machine-learning:
          model-cache:
            dir: /cache/
        immich-typesense:
          data:
            dir: /data/
        slskd:
          music:
            volume: mount-music
            dir: /music/
            ro: true
          data:
            dir: /app/
        monica:
          data:
            dir: /var/www/html/storage/
        mailserver:
          data:
            dir: /var/mail/
          state:
            dir: /var/mail-state/
          log:
            dir: /var/log/mail/
          config:
            dir: /tmp/docker-mailserver/
            ro: true
          traefik-cert:
            volume: traefik-cert
            dir: /etc/letsencrypt/
          cert:
            dir: /etc/letsencrypt/live/
        authelia:
          config:
            dir: /config/
            ro: true
        password-storage:
          config:
            volume: rclone-config
            dir: /etc/rclone/
            ro: true
        meilisearch:
          data:
            dir: /meili_data/
      backup:
        common:
          prefix: /volume/
          notification:
            topic: backup
            tags:
              - daily-backup
        cache:
          volume: restic-cache
          dir: /var/cache/restic/
        service:
          navidrome:
            stop:
              - navidrome
            volume:
              data:
                path:
                  - navidrome.db
          syncthing:
            stop:
              - syncthing
            volume:
              config:
                path:
                  - config/config.xml
                  - config/key.pem
                  - config/cert.pem
          telegram:
            volume:
              session:
                path:
                  - "."
          paperless-ngx:
            volume:
              export:
                path:
                  - "."
                script_path: _data/backup/script/paperless_ngx.py
          memos:
            stop:
              - memos
            volume:
              data:
                path:
                  - memos_prod.db
          immich:
            stop:
              - immich-server
              - immich-microservices
            postgres: true
          monica:
            stop:
              - monica
            postgres: true
          linkwarden:
            stop:
              - linkwarden
            postgres: true
          authelia:
            stop:
              - authelia
            postgres: true
          ryot:
            stop:
              - ryot
            postgres: true
      redis:
        - paperless-ngx
        - immich
        - monica
        - authelia
      postgres:
        immich:
        monica:
        linkwarden:
        authelia:
        ryot:
  service:
    value:
      tailscale:
        port:
          internal: 444
          external: 443
        socket: /var/run/tailscale/tailscaled.sock
      traefik:
        # TODO: Upgrade to v3
        schema:
          static: https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/traefik-v2.json
          dynamic: https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/traefik-v2-file-provider.json
        plugin:
          crowdsec:
            name: github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
            version: "v1.1.16"
          rewrite-response-headers:
            name: github.com/XciD/traefik-plugin-rewrite-headers
            version: "v0.0.4"
      webdav-storage:
        port: 8080
      script-server:
        port: 8080
        admin: admin
      ttyd:
        port: 8080
        option:
          disableReconnect: 1
          cursorStyle: bar
          fontSize: 16
          allowTransparency: 1
          drawBoldTextInBrightColors: 1
          enableTrzsz: 1
          disableLeaveAlert: 1
      telegram:
        session: /telegram/session/
        notification:
          topic: telegram
          icon: https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/Telegram_logo.svg/240px-Telegram_logo.svg.png
      ntfy:
        email-server:
          domain: private-ntfy
          service:
            monica: private-monica
            authelia: public-authelia
      password-storage:
        port: 8080
      meilisearch:
        port: 7070
      docker-browser:
        port: 5000
        mount-root: /volume/
        mount-secondary: misc/
        top:
          - slskd-data
